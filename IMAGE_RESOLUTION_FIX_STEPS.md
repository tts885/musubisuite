# 画像解像度問題の完全解決手順

## 🎯 問題の確認

ログから確認された問題:
```
[ERROR] [画像品質問題] Dataverseに保存された画像が低解像度です!
{
  fileName: '1011_サンプル請求書２.png',
  width: 144,
  height: 144,
  message: 'アップロード時に画像が圧縮またはリサイズされている可能性があります'
}
```

**原因**: Dataverseの画像列(`cx_filedata`)が自動的に画像を**144×144ピクセルにリサイズ**

## ✅ 解決策の実装

### ステップ1: Dataverseテーブルに新しい列を追加 ⭐ 必須

1. [Power Apps Maker](https://make.powerapps.com) にアクセス
2. 左メニュー > **テーブル** をクリック
3. **OCRドキュメント** (`cx_ocrdocumentses`) テーブルを見つけて開く
4. **列** タブで **+ 列** をクリック
5. 以下の設定で新しい列を作成:

   ```
   表示名: ファイルデータ（フル品質）
   名前: cx_filedata_fullquality
   データ型: 複数行テキスト
   形式: テキスト
   最大文字数: 1048576
   必須: いいえ
   検索可能: いいえ
   説明: 元の解像度を保持した画像のBase64データ
   ```

6. **保存** をクリック
7. **公開** をクリック

### ステップ2: コードの確認

すでに以下のファイルが修正されています:

✅ `src/services/ocrDataverseService.ts`
- アップロード時: `cx_filedata_fullquality` にフル品質のBase64を保存
- 取得時: `cx_filedata_fullquality` を優先的に使用

✅ `src/index.css`
- 画像レンダリングを最高品質に設定

✅ `src/components/ocr/OcrDocumentPreview.tsx`
- 高品質表示設定を追加

### ステップ3: アプリの再起動

```powershell
# フロントエンドを再起動
cd corexverse
npm run dev
```

### ステップ4: テスト手順

#### 4.1 新しい画像をアップロード

1. OCRアップロードページ (`/ocr/upload`) にアクセス
2. 高解像度の画像をアップロード（例: 1000×1000px以上）
3. アップロード完了を待つ

#### 4.2 画像品質を確認

1. アップロードした画像の詳細ページを開く
2. **F12キー**を押して開発者ツールを開く
3. **Console**タブで以下のログを確認:

```javascript
[画像サイズ検証] Dataverseから取得した画像の実際のサイズ
{
  fileName: "テスト画像.png",
  width: 1000,  // ← 元のサイズが保持されているか確認
  height: 1000,
  dataSource: "フル品質テキスト列" // ← これが表示されればOK
}
```

#### 4.3 期待される結果

✅ **成功の場合**:
- `dataSource: "フル品質テキスト列"` と表示される
- `width` と `height` が元の画像サイズと同じ
- 画面上の画像が鮮明に表示される

❌ **まだ問題がある場合**:
- `dataSource: "画像列（リサイズ版）"` と表示される
- `width: 144, height: 144` のまま
- → Dataverseの列追加が正しくできていない可能性

### ステップ5: 既存の画像を再アップロード（オプション）

既存の画像は古い方式で保存されているため、再アップロードが必要です:

1. ドキュメント一覧ページで既存の画像を削除
2. 同じ画像を再度アップロード
3. 新しい方式で保存される

## 🔧 トラブルシューティング

### 問題1: 列が見つからないエラー

**症状**: 
```
cx_filedata_fullquality is not a valid field
```

**解決策**:
1. Power Apps Makerで列が正しく作成されているか確認
2. テーブルを**公開**したか確認
3. ブラウザのキャッシュをクリア
4. アプリを再起動

### 問題2: まだ144×144で表示される

**原因**: 
- 古い画像を表示している
- または列追加前にアップロードされた画像

**解決策**:
1. 新しい画像をアップロードしてテスト
2. ブラウザのキャッシュをクリア: `Ctrl + Shift + Delete`
3. ハードリロード: `Ctrl + F5`

### 問題3: Base64データが長すぎるエラー

**症状**:
```
String or binary data would be truncated
```

**解決策**:
1. Dataverseの列設定で**最大文字数**が `1048576` になっているか確認
2. 画像サイズが大きすぎる場合（5MB以上）、圧縮を検討
3. 別の画像でテスト

## 📊 仕組みの説明

### 変更前（問題あり）
```
アップロード → Dataverse画像列(cx_filedata) → 自動リサイズ(144×144) → 低品質表示
```

### 変更後（解決済み）
```
アップロード → Dataverseテキスト列(cx_filedata_fullquality) → リサイズなし → 元の解像度で表示
              ↓
              画像列(cx_filedata) → サムネイル用(144×144)
```

### データフロー

1. **アップロード時**:
   ```typescript
   File → Base64変換 → {
     cx_filedata_fullquality: base64,  // フル品質（1000×1000）
     cx_filedata: base64                // サムネイル（144×144）
   }
   ```

2. **取得時**:
   ```typescript
   Dataverse → 優先順位:
     1. cx_filedata_fullquality  // あればこれを使用（フル品質）
     2. cx_filedata              // なければこれを使用（リサイズ版）
   ```

## 🎉 完成イメージ

修正後は以下が実現されます:

- ✅ アップロードした画像が**元の解像度のまま**表示される
- ✅ ズームイン・ズームアウトしても**画質が保たれる**
- ✅ 実サイズモードで**ピクセル単位で鮮明**に表示
- ✅ 一覧表示では144×144のサムネイルを使用（パフォーマンス最適化）

## 📝 チェックリスト

実装完了後、以下を確認してください:

- [ ] Dataverseに `cx_filedata_fullquality` 列を追加した
- [ ] 列の最大文字数が `1048576` になっている
- [ ] テーブルを公開した
- [ ] アプリを再起動した
- [ ] 新しい画像をアップロードした
- [ ] ブラウザコンソールで `dataSource: "フル品質テキスト列"` を確認した
- [ ] 画像が元のサイズで表示されることを確認した
- [ ] ズーム機能が正常に動作することを確認した

すべてチェックが完了したら、画像解像度問題は完全に解決されています! 🎊
