# OCR管理システム - Dataverseセットアップガイド

## 目次
1. [前提条件](#前提条件)
2. [テーブル作成手順](#テーブル作成手順)
3. [リレーションシップ設定](#リレーションシップ設定)
4. [サンプルデータ投入](#サンプルデータ投入)
5. [トラブルシューティング](#トラブルシューティング)

---

## 前提条件

### 必要なもの
- Microsoft 365アカウント
- Power Appsライセンス
- Dataverse環境へのアクセス権限
- システム管理者またはシステムカスタマイザーのロール

### アクセスURL
- Power Apps Maker Portal: https://make.powerapps.com
- Power Platform管理センター: https://admin.powerplatform.microsoft.com

---

## テーブル作成手順

### 1. OCRメニューセクションテーブル (cr_ocrmenusections)

#### 1.1 テーブルの作成

1. [Power Apps Maker Portal](https://make.powerapps.com)にアクセス
2. 左メニューから **「テーブル」** を選択
3. **「+ 新しいテーブル」** → **「列とデータから開始」** をクリック
4. テーブル名: `OCRメニューセクション`
5. 表示名(複数形): `OCRメニューセクション`
6. 説明: `OCR管理のメニューセクション(すべてのドキュメント等)`

#### 1.2 列の追加

テーブル作成後、以下の列を追加します:

| 列名 | 表示名 | データ型 | 必須 | 最大長 | 説明 |
|------|--------|---------|------|--------|------|
| cr_name | 名前 | 1行テキスト | ✓ | 100 | メニューセクション名 |
| cr_description | 説明 | 複数行テキスト | | 500 | メニューセクションの説明 |
| cr_displayorder | 表示順序 | 整数 | ✓ | | メニューの表示順序 |
| cr_isdefault | デフォルトメニュー | はい/いいえ | ✓ | | デフォルトメニューかどうか |
| cr_color | カラー | 1行テキスト | | 20 | メニューのカラーコード |

**列追加手順:**
1. テーブル詳細画面で **「+ 列を追加」** をクリック
2. 表示名、データ型、必須などを設定
3. **「保存」** をクリック
4. 上記の全列を追加

#### 1.3 主キー列の設定

- 主キー列 `cr_name` を使用
- または **「設定」** → **「詳細オプション」** → **「主キー列」** で `cr_name` を選択

---

### 2. OCRフォルダテーブル (cr_ocrfolders)

#### 2.1 テーブルの作成

1. **「+ 新しいテーブル」** をクリック
2. テーブル名: `OCRフォルダ`
3. 表示名(複数形): `OCRフォルダ`
4. 説明: `OCRドキュメントを管理する階層構造のフォルダ`

#### 2.2 列の追加

| 列名 | 表示名 | データ型 | 必須 | 最大長 | 説明 |
|------|--------|---------|------|--------|------|
| cr_name | フォルダ名 | 1行テキスト | ✓ | 200 | フォルダ名 |
| cr_description | 説明 | 複数行テキスト | | 1000 | フォルダの説明 |
| cr_color | カラー | 1行テキスト | | 20 | フォルダのカラーコード |
| cr_parentfolderid | 親フォルダ | **Lookup** | | | 親フォルダ(自己参照) |
| cr_menusectionid | メニューセクション | **Lookup** | ✓ | | 所属メニューセクション |
| cr_path | パス | 1行テキスト | ✓ | 500 | フォルダパス |
| cr_documentcount | ドキュメント数 | 整数 | ✓ | | フォルダ内のドキュメント数 |
| cr_foldercount | 子フォルダ数 | 整数 | ✓ | | 子フォルダの数 |

**Lookup列の作成手順:**

**cr_parentfolderid (親フォルダ - 自己参照):**
1. **「+ 列を追加」** をクリック
2. 表示名: `親フォルダ`
3. データ型: **「Lookup」** を選択
4. 関連テーブル: **「OCRフォルダ」** (同じテーブル)
5. 必須: いいえ
6. **「保存」**

**cr_menusectionid (メニューセクション):**
1. **「+ 列を追加」** をクリック
2. 表示名: `メニューセクション`
3. データ型: **「Lookup」**
4. 関連テーブル: **「OCRメニューセクション」**
5. 必須: はい
6. **「保存」**

---

### 3. OCRドキュメントテーブル (cr_ocrdocuments)

#### 3.1 テーブルの作成

1. **「+ 新しいテーブル」** をクリック
2. テーブル名: `OCRドキュメント`
3. 表示名(複数形): `OCRドキュメント`
4. 説明: `OCR処理対象のドキュメント`

#### 3.2 列の追加

| 列名 | 表示名 | データ型 | 必須 | 最大長 | 説明 |
|------|--------|---------|------|--------|------|
| cr_filename | ファイル名 | 1行テキスト | ✓ | 255 | ドキュメントのファイル名 |
| cr_filetype | ファイルタイプ | 1行テキスト | ✓ | 100 | MIMEタイプ |
| cr_filesize | ファイルサイズ | 整数 | ✓ | | ファイルサイズ(バイト) |
| cr_fileurl | ファイルURL | URL | ✓ | 2000 | ファイルの保存場所URL |
| cr_thumbnailurl | サムネイルURL | URL | | 2000 | サムネイル画像URL |
| cr_folderid | フォルダ | **Lookup** | | | 所属フォルダ |
| cr_projectid | プロジェクト | **Lookup** | | | 関連プロジェクト |
| cr_tags | タグ | 1行テキスト | | 500 | タグ(カンマ区切り) |
| cr_uploadedby | アップロード者 | **Lookup** | ✓ | | アップロード者 |
| cr_uploadeddate | アップロード日時 | 日付と時刻 | ✓ | | アップロード日時 |

**Lookup列の作成:**

**cr_folderid:**
- 関連テーブル: **「OCRフォルダ」**
- 必須: いいえ

**cr_uploadedby:**
- 関連テーブル: **「ユーザー」** (システムテーブル)
- 必須: はい

---

### 4. OCR処理結果テーブル (cr_ocrresults)

#### 4.1 テーブルの作成

1. **「+ 新しいテーブル」** をクリック
2. テーブル名: `OCR処理結果`
3. 表示名(複数形): `OCR処理結果`
4. 説明: `OCR処理の結果情報`

#### 4.2 列の追加

| 列名 | 表示名 | データ型 | 必須 | 最大長 | 説明 |
|------|--------|---------|------|--------|------|
| cr_name | 結果名 | 1行テキスト | ✓ | 100 | 処理結果名 |
| cr_documentid | ドキュメント | **Lookup** | ✓ | | 関連ドキュメント |
| cr_status | 処理ステータス | **選択肢** | ✓ | | ステータス |
| cr_rawtext | 全文テキスト | 複数行テキスト | | | OCRで抽出された全文テキスト |
| cr_overallconfidence | 全体信頼度 | 10進数 | ✓ | | 全体の信頼度スコア(0.0-1.0) |
| cr_processeddate | 処理完了日時 | 日付と時刻 | | | OCR処理完了日時 |
| cr_errormessage | エラーメッセージ | 1行テキスト | | 1000 | エラー発生時のメッセージ |

**選択肢 (cr_status) の作成:**
1. データ型: **「選択肢」** → **「選択肢」** (ローカル)
2. 選択肢の追加:
   - ラベル: `処理待ち`, 値: `1`
   - ラベル: `処理中`, 値: `2`
   - ラベル: `完了`, 値: `3`
   - ラベル: `失敗`, 値: `4`

**Lookup列 (cr_documentid):**
- 関連テーブル: **「OCRドキュメント」**
- 必須: はい
- リレーションシップの動作: **「参照」** (1対1の関係)

---

### 5. OCRフィールドテーブル (cr_ocrfields)

#### 5.1 テーブルの作成

1. **「+ 新しいテーブル」** をクリック
2. テーブル名: `OCRフィールド`
3. 表示名(複数形): `OCRフィールド`
4. 説明: `OCRで検出された個別フィールド`

#### 5.2 列の追加

| 列名 | 表示名 | データ型 | 必須 | 最大長 | 説明 |
|------|--------|---------|------|--------|------|
| cr_label | フィールド名 | 1行テキスト | ✓ | 100 | フィールドのラベル |
| cr_ocrresultid | OCR処理結果 | **Lookup** | ✓ | | 関連OCR処理結果 |
| cr_value | 値 | 1行テキスト | ✓ | 2000 | 検出されたテキスト値 |
| cr_confidence | 信頼度 | 10進数 | ✓ | | フィールドの信頼度スコア |
| cr_fieldtype | フィールドタイプ | **選択肢** | ✓ | | フィールドの種類 |
| cr_boundingbox_x | X座標 | 整数 | ✓ | | 画像上のX座標 |
| cr_boundingbox_y | Y座標 | 整数 | ✓ | | 画像上のY座標 |
| cr_boundingbox_width | 幅 | 整数 | ✓ | | バウンディングボックスの幅 |
| cr_boundingbox_height | 高さ | 整数 | ✓ | | バウンディングボックスの高さ |
| cr_isedited | 編集済み | はい/いいえ | ✓ | | ユーザーによって編集されたか |

**選択肢 (cr_fieldtype) の作成:**
1. データ型: **「選択肢」** → **「選択肢」** (ローカル)
2. 選択肢の追加:
   - ラベル: `テキスト`, 値: `1`
   - ラベル: `数値`, 値: `2`
   - ラベル: `日付`, 値: `3`
   - ラベル: `日時`, 値: `4`
   - ラベル: `メールアドレス`, 値: `5`
   - ラベル: `電話番号`, 値: `6`
   - ラベル: `住所`, 値: `7`

**Lookup列 (cr_ocrresultid):**
- 関連テーブル: **「OCR処理結果」**
- 必須: はい

---

## リレーションシップ設定

テーブル作成時にLookup列を作成することで、リレーションシップは自動的に作成されます。

### リレーションシップ一覧

| # | 関係名 | 元テーブル | 先テーブル | タイプ | 説明 |
|---|--------|-----------|-----------|--------|------|
| 1 | cr_ocrmenusection_ocrfolders | OCRメニューセクション | OCRフォルダ | 1:N | メニューセクション→フォルダ |
| 2 | cr_ocrfolder_parentfolder | OCRフォルダ | OCRフォルダ | 1:N | フォルダ親子関係(自己参照) |
| 3 | cr_ocrfolder_ocrdocuments | OCRフォルダ | OCRドキュメント | 1:N | フォルダ→ドキュメント |
| 4 | cr_ocrdocument_ocrresult | OCRドキュメント | OCR処理結果 | 1:1 | ドキュメント→OCR処理結果 |
| 5 | cr_ocrresult_ocrfields | OCR処理結果 | OCRフィールド | 1:N | OCR処理結果→フィールド |

### リレーションシップの確認方法

1. テーブルを開く
2. **「リレーションシップ」** タブを選択
3. 作成されたリレーションシップを確認

---

## サンプルデータ投入

### 1. OCRメニューセクション

Power Apps Maker Portalで:
1. **「OCRメニューセクション」** テーブルを開く
2. **「データ」** タブ → **「+ 新しい行」** をクリック
3. 以下のデータを入力:

| 名前 | 説明 | 表示順序 | デフォルトメニュー | カラー |
|------|------|---------|-------------------|--------|
| すべてのドキュメント | すべてのOCRドキュメント | 0 | はい | #3b82f6 |

### 2. OCRフォルダ

| フォルダ名 | 説明 | メニューセクション | 親フォルダ | パス | カラー |
|-----------|------|-------------------|-----------|------|--------|
| 請求書 | 請求書関連ドキュメント | すべてのドキュメント | (なし) | /請求書 | #3b82f6 |
| 見積書 | 見積書関連ドキュメント | すべてのドキュメント | (なし) | /見積書 | #10b981 |
| 契約書 | 契約書関連ドキュメント | すべてのドキュメント | (なし) | /契約書 | #f59e0b |
| 2024年度 | 2024年度請求書 | すべてのドキュメント | 請求書 | /請求書/2024年度 | #3b82f6 |

### 3. サンプルOCRドキュメント

実際のファイルアップロード後に作成します。

---

## トラブルシューティング

### 問題: Lookup列が作成できない

**原因:** 関連テーブルがまだ作成されていない

**解決策:**
1. 関連テーブルを先に作成
2. その後、Lookup列を作成

### 問題: リレーションシップが表示されない

**原因:** Lookup列のリレーションシップ設定が不完全

**解決策:**
1. Lookup列を削除
2. 再度正しい設定で作成

### 問題: データが保存できない

**原因:** 必須列が未入力

**解決策:**
- すべての必須列(✓マーク)にデータを入力

### 問題: セキュリティエラー

**原因:** テーブルへのアクセス権限がない

**解決策:**
1. Power Platform管理センターを開く
2. セキュリティロールを確認
3. 必要な権限を付与

---

## 次のステップ

1. ✅ テーブル作成完了
2. ✅ リレーションシップ設定完了
3. ✅ サンプルデータ投入完了
4. 🔄 フロントエンド実装 (useOcrDataverse.ts)
5. 🔄 API連携テスト
6. 🔄 本番環境デプロイ

---

## 参考資料

- [Dataverse テーブルの作成](https://docs.microsoft.com/ja-jp/power-apps/maker/data-platform/data-platform-create-entity)
- [列の追加と編集](https://docs.microsoft.com/ja-jp/power-apps/maker/data-platform/create-edit-field-portal)
- [リレーションシップの作成](https://docs.microsoft.com/ja-jp/power-apps/maker/data-platform/data-platform-entity-lookup)
- [Power Apps Maker Portal](https://make.powerapps.com)

---

**作成日:** 2025年11月18日  
**バージョン:** 1.0
